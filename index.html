<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="theme-color" content="#6366f1" />
    <meta
      name="theme-color"
      media="(prefers-color-scheme: dark)"
      content="#4f46e5"
    />

    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="EMI Tracker" />

    <!-- Manifest -->
    <link rel="manifest" href="./manifest.json" />

    <!-- Favicon and Apple Touch Icons -->
    <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="./icon-192.png" />
    <link rel="stylesheet" href="./index.css" />
    <title>EMI & Expense Tracker</title>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <h1>üí≥ EMI & Expense Tracker<span id="sealedBadge" class="sealed-badge" style="display: none;">üîí SEALED</span></h1>
        <div class="header-subtitle">
          Manage your EMIs and expenses offline, securely
        </div>
        <div class="header-actions">
          <button id="installButton" class="install-btn" style="display: none">
            <span class="install-icon">üì≤</span>
            <span>Install</span>
          </button>
          <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()">
            <span id="themeIcon">üåô</span>
            <span id="themeText">Dark</span>
          </button>
          <button class="data-btn" onclick="exportData()" id="export">üì• Export</button>
          <button
            class="data-btn"
            onclick="document.getElementById('importFile').click()"
          >
            üì§ Import
          </button>
          <input
            type="file"
            id="importFile"
            accept=".json"
            style="display: none"
            onchange="importData(event)"
          />
        </div>
      </div>
    </div>

    <!-- Summary Section -->
    <div class="summary-section">
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-label">Total Items</div>
          <div class="summary-value" id="totalEMIs">0</div>
        </div>
        <div class="summary-card warning">
          <div class="summary-label">Monthly Payment</div>
          <div class="summary-value" id="totalMonthly">‚Çπ0</div>
          <div class="summary-breakdown" id="monthlyBreakdown"></div>
        </div>
        <div class="summary-card success">
          <div class="summary-label">Total Debt</div>
          <div class="summary-value" id="totalDebt">‚Çπ0</div>
        </div>
      </div>
    </div>

    <!-- Search Bar -->
    <div class="search-section">
      <input
        type="text"
        id="searchInput"
        class="search-input"
        placeholder="üîç Search by name or amount..."
        oninput="handleSearch()"
      />
    </div>

    <!-- Sort & Filter Controls -->
    <div class="sort-controls">
      <div class="sort-bar">
        <div class="sort-group">
          <span class="sort-label">Sort By:</span>
          <select
            id="sortBy"
            class="sort-select"
            onchange="applySortAndGroup()"
          >
            <option value="entry">Entry Order</option>
            <option value="dueDate">Due Date</option>
            <option value="amount">Amount</option>
            <option value="endDate">End Date</option>
            <option value="periodLeft">Period Left</option>
            <option value="name">Name (A-Z)</option>
            <option value="type">Type</option>
            <option value="category">Category</option>
          </select>
          <button
            id="sortDirection"
            class="sort-direction-btn"
            onclick="toggleSortDirection()"
            title="Sort Direction"
          >
            ‚Üë
          </button>
        </div>
        <div class="sort-group">
          <span class="sort-label">Group By:</span>
          <select
            id="groupBy"
            class="sort-select"
            onchange="applySortAndGroup()"
          >
            <option value="none">No Grouping</option>
            <option value="category">Category</option>
            <option value="type">Type</option>
            <option value="dueDateRange">Due Date Range</option>
            <option value="status">Status</option>
          </select>
        </div>
        <div class="sort-group">
          <button class="view-toggle-btn" onclick="toggleArchivedView()">
            <span id="viewToggleText">üì¶ View Archive</span>
          </button>
        </div>
        <div class="sort-group">
          <button class="seal-control-btn" id="sealControlBtn" 
                  onclick="initiateSeal()" disabled 
                  title="Check at least one payment to enable">
            üîí Seal
          </button>
          <button class="info-btn" onclick="showSealInfo()" 
                  title="Learn about Seal Mode">
            ‚ÑπÔ∏è
          </button>
        </div>
      </div>
    </div>

    <!-- Table Section -->
    <div class="table-container">
      <div class="table-wrapper" id="tableWrapper">
        <div class="table-scroll">
          <table id="emiTable">
            <thead>
              <tr>
                <th class="checkbox-col">Paid</th>
                <th class="mandatory">Type</th>
                <th class="mandatory">Name</th>
                <th class="mandatory">Amount</th>
                <th class="mandatory">Due Date</th>
                <th class="mandatory">End Date</th>
                <th class="mandatory">Period Left</th>
                <th class="optional">Total Amount</th>
                <th class="optional">Principal Paid</th>
                <th class="optional">Interest Paid</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="emiTableBody">
              <!-- EMI rows will be inserted here -->
            </tbody>
          </table>
        </div>
        <div id="emptyState" class="empty-state" style="display: none">
          <div class="empty-state-icon">üìã</div>
          <h3>No Items Added Yet</h3>
          <p>Tap the + button below to add your first EMI or expense</p>
        </div>
      </div>
    </div>

    <!-- FAB Button -->
    <button class="fab" onclick="openModal()" aria-label="Add Item">+</button>

    <!-- Seal Confirmation Modal -->
    <div id="sealModal" class="modal">
      <div class="modal-content seal-modal">
        <div class="modal-header">
          <h2>‚ö†Ô∏è Seal Monthly Payments?</h2>
          <button class="close-btn" onclick="closeSealModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="seal-warning-box">
            <p class="seal-warning-title">This will LOCK all payments until:</p>
            <p class="seal-date" id="sealUntilDate">üìÖ February 1, 2026</p>
          </div>
          <ul class="seal-consequences">
            <li>‚úÖ Payments cannot be edited</li>
            <li>‚úÖ Checkboxes cannot be changed</li>
            <li>‚úÖ Status is permanent this month</li>
          </ul>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeSealModal()">Cancel</button>
          <button class="btn btn-danger" onclick="confirmSeal()">CONFIRM SEAL</button>
        </div>
      </div>
    </div>

    <!-- Seal Info Modal -->
    <div id="sealInfoModal" class="modal">
      <div class="modal-content info-modal">
        <div class="modal-header">
          <h2>‚ÑπÔ∏è About Seal Mode</h2>
          <button class="close-btn" onclick="closeSealInfoModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="info-warning">
            <p>‚ö†Ô∏è <strong>This is a serious commitment</strong></p>
          </div>
          
          <div class="info-section">
            <h3>‚è±Ô∏è What Happens When You Seal:</h3>
            <ol class="info-steps">
              <li><strong>3-second countdown</strong> - Last chance to press STOP</li>
              <li><strong>5-second undo period</strong> - Final window to press UNDO</li>
              <li><strong>Total: 8 seconds of deliberation</strong></li>
            </ol>
          </div>
          
          <div class="info-section">
            <h3>üîí During These 8 Seconds:</h3>
            <ul class="info-restrictions">
              <li>‚ùå Cannot edit items</li>
              <li>‚ùå Cannot check/uncheck payments</li>
              <li>‚ùå Cannot delete items</li>
              <li>‚ùå Cannot add new items</li>
            </ul>
          </div>
          
          <div class="info-section">
            <h3>‚úÖ After Sealing:</h3>
            <ul class="info-benefits">
              <li>üîí All payments locked until next month</li>
              <li>üõ°Ô∏è Protected from accidental touches</li>
              <li>üßò Financial peace of mind achieved</li>
              <li>üìÖ Auto-unlocks on the 1st of next month</li>
            </ul>
          </div>
          
          <div class="info-caution">
            <p><strong>Use wisely. This is a one-way action for this month.</strong></p>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="closeSealInfoModal()">
            Got It!
          </button>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div id="emiModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Add New Item</h2>
          <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
          <form id="emiForm">
            <!-- Type Toggle -->
            <div class="type-toggle">
              <div class="type-option">
                <input
                  type="radio"
                  id="typeEMI"
                  name="itemType"
                  value="emi"
                  checked
                  onchange="toggleFormFields()"
                />
                <label for="typeEMI">
                  <span class="type-badge">üí≥</span>
                  <span>EMI</span>
                </label>
              </div>
              <div class="type-option">
                <input
                  type="radio"
                  id="typeExpense"
                  name="itemType"
                  value="expense"
                  onchange="toggleFormFields()"
                />
                <label for="typeExpense">
                  <span class="type-badge">üè†</span>
                  <span>Constant Expense</span>
                </label>
              </div>
            </div>

            <!-- Mandatory Fields -->
            <div class="form-section">
              <div class="form-section-title">
                <span>Mandatory Information</span>
                <span class="required-badge">REQUIRED</span>
              </div>

              <div class="form-group">
                <label for="emiCategory"
                  >Category <span class="required">*</span></label
                >
                <select
                  id="emiCategory"
                  required
                  onchange="toggleCategoryFields()"
                >
                  <option value="expense" id="categoryExpenseOption">
                    Expense/Debt
                  </option>
                  <option value="savings">Savings</option>
                </select>
              </div>

              <div class="form-group">
                <label for="emiName" id="nameLabel"
                  >Name <span class="required">*</span></label
                >
                <input
                  type="text"
                  id="emiName"
                  required
                  placeholder="e.g., Home Loan, Car EMI"
                />
              </div>

              <div class="form-group">
                <label for="emiAmount" id="amountLabel"
                  >Monthly Amount (‚Çπ) <span class="required">*</span></label
                >
                <input
                  type="number"
                  id="emiAmount"
                  required
                  placeholder="e.g., 5000"
                  step="0.01"
                  min="1"
                  max="100000000"
                />
              </div>

              <div class="form-group">
                <label for="dueDate"
                  >Monthly Due Date <span class="required">*</span></label
                >
                <input
                  type="number"
                  id="dueDate"
                  required
                  placeholder="e.g., 5"
                  min="1"
                  max="31"
                />
                <div class="helper-text">Day of the month (1-31)</div>
              </div>

              <div class="form-group" id="endDateGroup">
                <label for="emiEndDate" id="endDateLabel">
                  End Date <span class="required" id="endDateRequired">*</span>
                </label>
                <input type="date" id="emiEndDate" />
                <div
                  class="helper-text"
                  id="endDateHelper"
                  style="display: none"
                >
                  Optional for ongoing expenses like rent
                </div>
              </div>
            </div>

            <!-- Optional Fields (EMI Only) -->
            <div
              class="form-section field-conditional active"
              id="emiOnlyFields"
            >
              <div class="form-section-title">
                <span>EMI Details</span>
                <span class="optional-badge">OPTIONAL</span>
              </div>

              <div class="form-group">
                <label for="totalAmount">Total Amount Bought (‚Çπ)</label>
                <input
                  type="number"
                  id="totalAmount"
                  placeholder="e.g., 500000"
                  step="0.01"
                  min="0"
                  max="1000000000"
                />
              </div>

              <div class="form-group">
                <label for="principalPaid">Principal Paid (‚Çπ)</label>
                <input
                  type="number"
                  id="principalPaid"
                  placeholder="e.g., 50000"
                  step="0.01"
                  min="0"
                  max="1000000000"
                />
              </div>

              <div class="form-group">
                <label for="interestPaid">Interest Paid (‚Çπ)</label>
                <input
                  type="number"
                  id="interestPaid"
                  placeholder="e.g., 10000"
                  step="0.01"
                  min="0"
                  max="1000000000"
                />
              </div>
            </div>

            <input type="hidden" id="editIndex" value="" />
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closeModal()"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            form="emiForm"
            id="submitBtn"
          >
            Add Item
          </button>
        </div>
      </div>
    </div>

    <!-- Payment Success Toast -->
    <div id="paymentToast" class="payment-toast"></div>
    <div id="superToast" class="super-toast">
      üíö Fully paid up! No stress, no worries, no surprises. This is what
      financial peace feels like. Well done! ‚òÆÔ∏è
    </div>

    <!-- Seal Toast Notifications -->
    <div id="countdownToast" class="seal-toast countdown-toast">
      <span id="countdownText">‚è≥ Sealing... (3s)</span>
      <button class="toast-btn" onclick="abortSeal()">STOP</button>
    </div>

    <div id="undoToast" class="seal-toast undo-toast">
      <span id="undoText">‚úÖ Sealed! (5s)</span>
      <button class="toast-btn" onclick="undoSeal()">UNDO</button>
    </div>
    
    <!-- Sealing Overlay -->
    <div id="sealingOverlay" class="sealing-overlay"></div>

    <script src="./script.js"></script>
  </body>
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("./sw.js")
        .then(function (registration) {
          console.log(
            "Service Worker registered with scope:",
            registration.scope
          );
        })
        .catch(function (error) {
          console.log("Service Worker registration failed:", error);
        });
    }
  </script>
  <script>
    let deferredPrompt;
    const installButton = document.getElementById("installButton");

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installButton.style.display = "inline-flex";
    });

    installButton.addEventListener("click", async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const choiceResult = await deferredPrompt.userChoice;
      deferredPrompt = null;
      installButton.style.display = "none";
    });
  </script>
</html>
